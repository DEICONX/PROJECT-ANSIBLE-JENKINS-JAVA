
---
- name: Install Maven, Build Java Project, Install and Start Nexus, Upload WAR Artifact
  hosts: S2
  become: yes

  vars:
    nexus_version: "3.86.2-01"
    nexus_tarball: "nexus-{{ nexus_version }}-linux-x86_64.tar.gz"
    nexus_download_url: "https://download.sonatype.com/nexus/3/{{ nexus_tarball }}"
    nexus_install_dir: "/home/{{ ansible_user }}/nexus-{{ nexus_version }}"
    project_dir: "/home/{{ ansible_user }}/project"
    git_repo: "https://github.com/DEICONX/DOCKER-PROJECT-JAVA.git"
    nexus_repo_url: "http://44.223.60.218:8081/repository/maven-releases/"
    nexus_repo_id: "maven-releases"   # âœ… Matches settings.xml
    nexus_username: "admin"
    nexus_password: "admin"

  tasks:
    # âœ… Update and install dependencies
    - name: Update apt packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install Java 17
      apt:
        name: openjdk-17-jdk
        state: present

    - name: Install Maven
      apt:
        name: maven
        state: present

    # âœ… Configure Maven settings.xml for Nexus authentication
    - name: Ensure .m2 directory exists
      file:
        path: "/home/{{ ansible_user }}/.m2"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Create Maven settings.xml with Nexus credentials
      copy:
        dest: "/home/{{ ansible_user }}/.m2/settings.xml"
        content: |
          <settings>
            <servers>
              <server>
                <id>{{ nexus_repo_id }}</id>
                <username>{{ nexus_username }}</username>
                <password>{{ nexus_password }}</password>
              </server>
            </servers>
          </settings>
        mode: '0644'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    # âœ… Clone project
    - name: Remove existing project directory
      file:
        path: "{{ project_dir }}"
        state: absent

    - name: Clone GitHub repo
      git:
        repo: "{{ git_repo }}"
        dest: "{{ project_dir }}"
      become_user: "{{ ansible_user }}"

    # âœ… Detect pom.xml dynamically
    - name: Find pom.xml file
      find:
        paths: "{{ project_dir }}"
        patterns: "pom.xml"
        recurse: yes
      register: pom_file

    - name: Fail if no pom.xml found
      fail:
        msg: "No pom.xml found in the project!"
      when: pom_file.matched == 0

    - name: Set Maven build directory
      set_fact:
        maven_build_dir: "{{ pom_file.files[0].path | dirname }}"

    # âœ… Extract Maven coordinates
    - name: Extract Maven groupId
      command: mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout
      args:
        chdir: "{{ maven_build_dir }}"
      become_user: "{{ ansible_user }}"
      register: group_id

    - name: Extract artifactId
      command: mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout
      args:
        chdir: "{{ maven_build_dir }}"
      become_user: "{{ ansible_user }}"
      register: artifact_id

    - name: Extract version
      command: mvn help:evaluate -Dexpression=project.version -q -DforceStdout
      args:
        chdir: "{{ maven_build_dir }}"
      become_user: "{{ ansible_user }}"
      register: version_id

    - name: Set Maven coordinates facts
      set_fact:
        mvn_group_id: "{{ group_id.stdout }}"
        mvn_artifact_id: "{{ artifact_id.stdout }}"
        mvn_version_id: "{{ version_id.stdout }}"

    # âœ… Build Maven project
    - name: Build Maven project
      command: mvn clean package
      args:
        chdir: "{{ maven_build_dir }}"
      become_user: "{{ ansible_user }}"

    # ===============================================================
    # ðŸ‘‰ After Maven build completed: Install Nexus FIRST & start it
    # ===============================================================

    - name: Download Nexus tarball
      get_url:
        url: "{{ nexus_download_url }}"
        dest: "/home/{{ ansible_user }}/{{ nexus_tarball }}"

    - name: Extract Nexus tarball
      unarchive:
        src: "/home/{{ ansible_user }}/{{ nexus_tarball }}"
        dest: "/home/{{ ansible_user }}"
        remote_src: yes

    - name: Change ownership of Nexus directory
      file:
        path: "{{ nexus_install_dir }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: yes

    - name: Start Nexus
      command: "{{ nexus_install_dir }}/bin/nexus start"

    # âœ… Check Nexus status
    - name: Check Nexus status
      command: "{{ nexus_install_dir }}/bin/nexus status"
      register: nexus_status
      changed_when: false

    - debug:
        msg: "Nexus status: {{ nexus_status.stdout }}"

    # âœ… Validate Nexus credentials (moved after Nexus is up)
    - name: Validate Nexus credentials
      command: >
        curl -u {{ nexus_username }}:{{ nexus_password }} -s -o /dev/null -w "%{http_code}" {{ nexus_repo_url }}
      register: nexus_auth_check
      changed_when: false

    - name: Fail if Nexus authentication fails
      fail:
        msg: "Nexus authentication failed! Check username/password."
      when: nexus_auth_check.stdout != "200"

    # âœ… Upload WAR Artifact to Nexus
    - name: Find built WAR file
      find:
        paths: "{{ maven_build_dir }}/target"
        patterns: "*.war"
      register: war_file

    - name: Fail if no WAR found
      fail:
        msg: "No WAR file found in target directory!"
      when: war_file.matched == 0

    - name: Upload WAR artifact to Nexus
      command: >
        mvn deploy:deploy-file
        --settings /home/{{ ansible_user }}/.m2/settings.xml
        -Dfile={{ war_file.files[0].path }}
        -DgroupId={{ mvn_group_id }}
        -DartifactId={{ mvn_artifact_id }}
        -Dversion={{ mvn_version_id }}
        -Dpackaging=war
        -DrepositoryId={{ nexus_repo_id }}
        -Durl={{ nexus_repo_url }}
        -DgeneratePom=true
      args:
        chdir: "{{ maven_build_dir }}"
      become_user: "{{ ansible_user }}"

